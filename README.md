# README

TheHiveHook_Go_Package является посредником между TheHive и NATS и применяется для передачи кейсов и алертов TheHive, через брокер сообщений NATS, любым другим заинтересованным системам

## Конфигурационные настройки

Конфигурационные параметры для сервиса могут быть заданы как через конфигурационный файл так и методом установки переменных окружения. Однако, все пароли и
ключевые токены, используемые для авторизации, задаются ТОЛЬКО через переменные окружения.

#### Типы конфигурационных файлов:

- config.yaml общий конфигурационный файл
- config_dev.yaml конфигурационный файл используемый для тестов при разработке
- config_prod.yaml конфигурационный файл применяемый в продуктовом режиме

Основная переменная окружения для данного приложения - GO_HIVEHOOK_MAIN. На основании значения этой переменной принимается решение какой из конфигурационных файлов config_dev.yaml или config_prod.yaml использовать. При GO_HIVEHOOK_MAIN=development будет использоваться config_dev.yaml, во всех остальных случаях, в том числе и при отсутствии переменной окружения GO_HIVEHOOK_MAIN будет использоваться конфигурационный файл config_prod.yaml. Перечень переменных окружения которые можно использовать для настройки приложения:

#### Переменная окружения отвечающая за тип запуска приложения "development" или "production"

- GO_HIVEHOOK_MAIN

#### Переменные окружения отвечающие за подключение к NATS

- GO_HIVEHOOK_NPREFIX
- GO_HIVEHOOK_NHOST
- GO_HIVEHOOK_NPORT
- GO_HIVEHOOK_NCACHETTL - данный параметр должен содержать время жизни записи
  кэша, по истечение которого запись автоматически удаляется, значение задается
  в секундах в диапазоне от 10 до 86400 секунд
- GO_HIVEHOOK_NSUBSENDERCASE - канал для отправки в него информации по case
- GO_HIVEHOOK_NSUBSENDERALERT - канал для отправки в него информации по alert
- GO_HIVEHOOK_NSUBLISTENERCOMMAND - канал для приема команд которые нужно выполнить на TheHive

#### Переменные окружения отвечающие за подключение к TheHive

- GO_HIVEHOOK_THHOST
- GO_HIVEHOOK_THPORT
- GO_HIVEHOOK_THCACHETTL - данный параметр должен содержать время жизни записи
  кэша, по истечение которого запись автоматически удаляется, значение задается
  в секундах в диапазоне от 10 до 86400 секунд
- GO_HIVEHOOK_THAPIKEY - ЭТО ОБЯЗАТЕЛЬНЫЙ ПАРАМЕТР!!!
  Он задается ТОЛЬКО через переменную окружения. В конфигурационном
  файле этого параметра нет.

#### Переменные окружения отвечающие за настройки WebHook сервера

- GO_HIVEHOOK_WEBHNAME //наименование сервера (gcm, rcmnvs и т.д.)
- GO_HIVEHOOK_WEBHHOST
- GO_HIVEHOOK_WEBHPORT
- GO_HIVEHOOK_WEBHTTLTMPINFO //время жизни временной информации, в секундах от 10 до 86400

#### Переменные окружения отвечающие за настройки доступа к БД в которую будут записыватся логи

- GO_HIVEHOOK_DBWLOGHOST // доменное имя или ip БД
- GO_HIVEHOOK_DBWLOGPORT // порт БД
- GO_HIVEHOOK_DBWLOGNAME // наименование БД (при необходимости)
- GO_HIVEHOOK_DBWLOGSTORAGENAME // наименование объекта хранения логов (таблица, документ, индекс и т.д. зависит от типа БД)
- GO_HIVEHOOK_DBWLOGUSER // пользователь БД
- GO_HIVEHOOK_DBWLOGPASSWD // пароль для доступа к БД

Настройки логирования данных в БД не являются обязательными и необходимы только если пользователь приложения желает хранить логи в базе данных

Приоритет значений заданных через переменные окружения выше чем значений полученных из конфигурационных файлов.

## Примеры команд передаваемые TheHiveHook_Go_Package

Все команды для TheHiveHook_Go_Package представляют собой JSON объекты передаваемые
в бинарном виде. Структура и значение команд обрабатываемых TheHiveHook_Go_Package:

```
{
  "service": "<наименование сервиса>" //обязательный параметр
  "command": <команда>
  "root_id": "<основной id, как правило это rootId case или alert>" //обязательный параметр только для некоторых действий выполняемых с конкретным кейсом или алертом
  "case_id": "<id кейса, если есть>"
  "username": <имя пользователя> //необходим если нужно указать пользователя выполнившего действие
  "field_name": <некое ключевое поле>
  "value": <устанавливаемое значение>
  "byte_data": <набор данных в бинарном виде>
}
```

##### Перечень видов обрабатываемых команд:

- "add_case_tag"
- "add_case_task"
- "set_case_custom_field"

Пример команды для добавления тега:

```
{
  "service": "MISP",
  "command": "add_case_tag",
  "root_id": "~74395656",
  "case_id": "13435",
  "value": "Webhook: send=\"MISP\""
}
```

Пример команды для добавления задачи:

```
{
  "service": "MISP",
  "command": "add_case_task",
  "root_id": "~74395656",
  "username": "architector@33c.rcm",
  "field_name": "Developers",
  "value": "handling request"
}
```

Пример команды для добавления поля custom field:

```
{
  "service": "MISP",
  "command": "set_case_custom_field",
  "root_id": "~74395656",
  "field_name": "misp-event-id.string",
  "value": "3221"
}
```

##### Структура ответа на любую из переданных команд

```
{
  id: "",
  error: "",
  command: "",
  status_code: 0,
  data: <дополнительные_данные_возможны_в_любом_типе>
}
```

## Настройка TheHive

```
curl -XPUT -u <имя*пользователя>:'пароль_org-admin' -H 'Content-type: application/json' <url*или*ip*и*сетевой*порт>/api/config/organisation/notification -d
  '{
    "value": [
      {
        "delegate": false,
        "trigger": {"name": "AnyEvent"},
        "notifier": {"name": "webhook", "endpoint": "hivehook"}
      }
    ]
  }'
```
